services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: socratic-backend
    ports:
      # Port 8880 — supported by Cloudflare proxy (free tier), not conflicting with other services.
      - "8880:8880"
    volumes:
      # GGUF model — place the file at ./models/ on the host before starting
      - ./models:/app/models
      # Persist the file-based user DB across container restarts/rebuilds
      - ./data:/app/data
      # Persist admin-uploaded course content
      - ./content:/app/content
    environment:
      - ENVIRONMENT=production
      - PORT=8880
      # Override any of these in your .env file on the server
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - MODEL_PATH=/app/models/socratic-q4_k_m.gguf
      - N_GPU_LAYERS=${N_GPU_LAYERS:-0}
      - N_THREADS=${N_THREADS:-4}
      - N_CTX=${N_CTX:-4096}
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8880/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
